> # 2021-A 信号失真度测量
> ## 一、系统方案设计与论证
> ### 1.方案分析与选择
> #### 1）自动增益控制（AGC）电路设计方案
> #####  基于 VCA821 的 AGC 电路。VCA821 是一款直流耦合、宽带、dB线性的压控增益放大器。VCA821 之后增加OPA695作为后级放大，输出信号再经过OPA820积分器，连接至 VCA821的VG引脚形成闭环，从而保证输出信号的稳定性。该方案的优点是原理清晰，且输入信号电压范围广、频率响应好、输出电压稳定性好，缺点是电路较为复杂
> #### 2）ADC 前端调理电路设计方案
> ##### 采用同相加法器，对 AGC 电路输出信号跟随后进行抬升 1.65V，同相放大器输入阻抗高，对前级影响小。
>#### 3）信号采样设计方案
>##### 利用stm32顺序采样。顺序采样方式主要用于数字示波器中，这种方式能以极低的采样速率（100 kHz ~200kHz）获得极高的带宽（高达 50GHz），并且垂直分辨率一般都在 10bit 以上。由于在每个采样周期只取波形上的一个样点，每次延迟一个已知的时间，因此采集足够多的样点，需要更长的时间。该方案的优点是可以使用较小的采样频率采集频率较高的信号，缺点是测量一次所花时间较长。
>### 2.总体方案描述
>##### 本系统采用AGC电路对输入周期信号进行前级处理，结合ADC前端调理电路，将信号变换至ADC采集范围内，采用单片机的内部ADC 对输出信号进行采样，经FFT 算法分析得到基波与谐波的归一化幅值，运算处理得到 THD，并在串口屏上进行显示。

>## 二、理论分析与计算
>### 1. 测量原理分析与计算
>##### 由于STM32的内部ADC 采样频率受限，为了满足题目要求无法直接使用传统的实时采样法。因此这里我们先使用 ADC 实时采样并通过 FFT 获取信号的基频，再根据基频修改采样频率，重新进行一轮 ADC 顺序采样。最后通过 FFT 运算得到信号的频谱，从而计算出信号的 THD、归一化幅值并还原波形。
>#### 1）ADC 顺序采样
>##### 顺序采样是在一个或多个被测量信号周期内取样一次，取样信号每次延迟t +nT ，因此在已知基波频率 fo 的情况下，可以倒推出所需采样频率 fs 。<br>据题，输入信号频率为 1kHz~100kHz，我们设定一个周期波形采样的点数为64，即n = 64 。使用14位内部ADC采集信号，设置ADC 采样点数，采样频率为：
<div align=center><img src="[picture/图片1.png]"></div>
>#### 2）FFT 计算频谱
>##### 在时域下对采集到的 1024 点信号序列进行 FFT 变换，得到输出序列为:
>### 2.误差分析
>##### 在本系统中，产生误差的原因主要有三个：<br>1）单片机内部 ADC 性能影响。如果需要满足奈奎斯特采样定理，采样频率需大 于输入信号最高频率的两倍，以减少或者消除混叠效应；而当采样频率过大时，ADC 的精度会受到一定影响。同时 ADC 在每次测量电压时会存在转换时间，使每次采样 间隔并不完全相同，从而产生误差。<br>2）使用 DSP 库中的 FFT 函数存在误差。对于信号来说，只有那些周期（或者周 期的倍数）刚好和信号长度相同时，频谱泄漏才不会发生。虽然理论上可以根据信号 调整某数转换器的采用频率得到，但在实际中很难进行操作，因此我们在测量过程中 频谱泄漏的情况总是存在的。同时可能由于分辨率较低，从而产生栏栅效应。<br><br>针对以上的误差，改进的方法如下:<br>1）尽量选择板载 ADC 性能较好的主控。同时使用顺序采样的方法，不需要将 ADC 采样频率设置过高，从而可以减小误差。<br>2）为了控制频谱泄漏，可以对信号进行 FFT 变换前加窗，加入对应的窗函数， 如常用的 Hanning 窗函数；对应栏栅效应，可以进行补零等操作，从而提高频率分辨 率。最后要尽量保证系统测量的频率是频率分辨率的整数倍，这样可以最大程度上减 小频谱泄漏带来的误差。

>## 三、电路与程序设计
>### 1.电路设计
>#### 1）基于 VCA821 的 AGC 电路
>##### 根据上述的方案设计和原理分析，通过参数计算和实际调试，设计出基于VCA821的 AGC 电路如图所示。当需要动态信号幅度校正时，AGC 环路将提供实时增益控制。VCA821 输出信号经过OPA695提供额外的负载驱动能力，再经过 OPA820 积分器，连接至 VCA821 的 VG 引脚形成闭环，环路的时间常数由电容 C2 和电阻 R9 设置

>#### 2）ADC 前端调理电路
>##### STM32和ESP32片内ADC的输入电压范围为 0~3.3V，需采用前端调理电路对输入信号进行处理。采用OPA227构成电压跟随器，起到缓冲、隔离、提高带载能力的作用，再使用 REF3030 产生+3V基准电压，经过电阻分压网络将+1.65V 直流电位叠加至原 信号，利于 ADC 充分采样，电路如图所示
>### 2.程序设计
>##### 根据题目要求，程序主要包含 ADC 顺序采样、THD 计算、波形还原以及测量结果显示等功能，满足题目各项功能要求。<br>设计思路为：<br>1)系统开启电源后，首先对各个模块进行初始化，当有信号输入时stm32开始进行第一轮 ADC 实时采样；<br>2)stm32讲采样数据通过串口发送给esp32；<br>3)esp32通过 FFT 得到输入信号的基频并通过串口回传给stm32；<br>4)stm32根据预设在一个周期 上需要采样的点数，设置自适应后的重装载值从而修改采样频率；<br>5)修改参数后重新进行一轮 ADC 顺序采样，采集 1024 个点传给esp32；<br>6)esp32并进行 FFT 运算，根据得到的频谱计算出 THD、归一化幅值并还原波形；<br>7)将结果显示到串口屏上；最后还原采样频率重新进行新一轮采样并显示测量结果。

>## 四、测试方案与测试结果
>### 1. 信号失真度 THD 测量
| 基频/khz|峰峰值/mv|实际THD |测试THD|
 |:--------:| :---------:|:--------:|:--------:|
  | 1kHz | 500mv |40%|40%|
  | 37kHz | 500mv |40%|41%|
  | 10kHz | 500mv |40%|40%|
  | 89kHz | 500mv |40%|41%|
  | 250kHz | 500mv |40%|40%|
  | 1kHz | 15mv |40%|40%|
  | 1kHz | 7mv |40%|41%|
   | 1kHz | 2mv |90%|92%|
>### 2. 数据显示测试
| 测量信息显示设备 |失真度测量值THD|归一化幅值 |一个周期波形|
 |:--------:| :---------:|:--------:|:--------:|
  | 串口屏 | 正常 |正常|正常|
>## 五、总结
>##### 本系统通过理论分析得到合理的方案，以 STM32和ESP32为控制核心，结合基于VCA821的 AGC电路和ADC前端调理电路，设计并实现了信号失真度测量装置，完成了对输入周期信号的总谐波失真度和归一化幅值的测量与显示，且各项指标均满足设计要求
